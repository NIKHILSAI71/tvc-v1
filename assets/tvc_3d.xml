<!--
  Realistic 3D MJCF model of a thrust-vector-controlled rocket with
  full 6DOF movement and AI-controlled thrust magnitude for real-time training.

  Scale: 1:100 SpaceX Falcon 9 First Stage
  - Real F9: 25,600 kg empty, 70m tall, 3.66m diameter
  - Model: ~256 kg, 0.7m tall, 0.0366m (3.66cm) diameter
  - Thrust: 8540 N max (T/W = 3.4, matching real F9)
  - TVC: ±8° gimbal (real Merlin 1D spec)
-->
<mujoco model="tvc_rocket_3d">
  <compiler angle="radian" inertiafromgeom="true"/>
  <option timestep="0.002" gravity="0 0 -9.81" integrator="RK4">
    <flag constraint="enable" limit="enable"/>
  </option>

  <default>
    <joint armature="0.0" damping="0.2" limited="true"/>
    <geom density="1000" friction="0.8 0.2 0.1"/>
    <motor gear="1" ctrlrange="-1 1"/>
  </default>

  <asset>
    <!-- Enhanced textures for 3D visualization -->
    <texture name="sky" type="skybox" builtin="gradient" rgb1="0.75 0.86 0.97" rgb2="0.94 0.98 1.0" width="1024" height="1024"/>
    
    <!-- Realistic grass ground texture - procedural checker pattern with natural grass colors -->
    <texture name="grass_texture" type="2d" builtin="checker" rgb1="0.2 0.45 0.15" rgb2="0.25 0.5 0.2" width="512" height="512"/>
    
    <!-- Enhanced materials for 3D realism -->
    <material name="ground_mat" texture="grass_texture" texrepeat="200 200" reflectance="0.02"/>
    <material name="rocket_white" rgba="0.95 0.95 0.98 1" specular="0.6" shininess="0.8"/>
    <material name="rocket_black" rgba="0.08 0.08 0.1 1" specular="0.4" shininess="0.6"/>
    <material name="engine_metal" rgba="0.4 0.42 0.48 1" specular="0.8" shininess="0.9"/>
    <material name="gimbal_frame" rgba="0.3 0.32 0.38 1" specular="0.7" shininess="0.8"/>
    <material name="flame" rgba="0.98 0.5 0.1 0.7" emission="0.6"/>
    <material name="thrust_trail" rgba="0.9 0.4 0.05 0.4" emission="0.4"/>
  </asset>

  <worldbody>
    <!-- Enhanced ground plane with landing area markers -->
    <body name="ground" pos="0 0 0">
      <geom name="ground_plane" type="plane" size="100 100 1" material="ground_mat"/>
      
      <!-- Landing pad visualization -->
      <geom name="landing_pad" type="cylinder" pos="0 0 0.01" size="2 0.01" rgba="1 1 0 0.8" contype="0" conaffinity="0"/>
      <geom name="landing_target" type="cylinder" pos="0 0 0.02" size="0.3 0.005" rgba="1 0 0 0.9" contype="0" conaffinity="0"/>
    </body>

    <!-- Realistic 3D rocket with full 6DOF movement - 256 kg total mass -->
    <body name="vehicle" pos="0 0 50">
      <!-- Free joint for full 6DOF movement (position + orientation) -->
      <freejoint name="vehicle_free"/>

      <!-- REDESIGNED: Smooth single-piece rocket body - F9 proportions, 256 kg total mass
           Research: "Rocket body should have smooth finish" - NO visible seams or rings -->
      <geom name="rocket_main" type="cylinder" pos="0 0 0" size="0.25 2.5" material="rocket_white" mass="220.0"/>

      <!-- REDESIGNED: Tangent ellipsoid nose - INSERTED into body for perfect blend
           Mathematical tangent connection: ellipsoid max diameter = cylinder diameter
           Body cylinder: radius=0.25m, top edge at Z=2.5
           Ellipsoid: rx=ry=0.25m (matches cylinder), rz=0.8m (nose length)
           CENTER at Z=2.5 → max width at cylinder top edge → PERFECT tangent blend!
           Ellipsoid extends: Z=1.7 (hidden inside) to Z=3.3 (visible tip)
           Visual-only (no collision) to prevent self-collision with body -->
      <geom name="nose_cone" type="ellipsoid" 
            pos="0 0 2.5" 
            size="0.25 0.25 0.8" 
            material="rocket_white" 
            mass="10.0"
            contype="0" conaffinity="0"/>

      <!-- Four grid fins for realistic 3D aerodynamics -->
      <geom name="fin_1" type="box" pos="0.35 0 -2.2" size="0.18 0.03 0.25" material="rocket_black" mass="2.5"/>
      <geom name="fin_2" type="box" pos="-0.35 0 -2.2" size="0.18 0.03 0.25" material="rocket_black" mass="2.5"/>
      <geom name="fin_3" type="box" pos="0 0.35 -2.2" size="0.03 0.18 0.25" material="rocket_black" mass="2.5"/>
      <geom name="fin_4" type="box" pos="0 -0.35 -2.2" size="0.03 0.18 0.25" material="rocket_black" mass="2.5"/>

      <!-- Landing legs (folded position) -->
      <geom name="leg_1" type="capsule" fromto="0.2 0.2 -2.0 0.4 0.4 -2.8" size="0.02" material="rocket_black" mass="2.0"/>
      <geom name="leg_2" type="capsule" fromto="-0.2 0.2 -2.0 -0.4 0.4 -2.8" size="0.02" material="rocket_black" mass="2.0"/>
      <geom name="leg_3" type="capsule" fromto="-0.2 -0.2 -2.0 -0.4 -0.4 -2.8" size="0.02" material="rocket_black" mass="2.0"/>
      <geom name="leg_4" type="capsule" fromto="0.2 -0.2 -2.0 0.4 -0.4 -2.8" size="0.02" material="rocket_black" mass="2.0"/>
      
      <!-- Center of mass marker -->
      <site name="vehicle_cg" pos="0 0 0" size="0.04" rgba="1 0 0 1"/>
      
      <!-- FULLY REDESIGNED: TVC System COMPLETELY INSIDE rocket body
           Research findings applied:
           - "Gimbal is pivot at TOP of combustion chamber" 
           - "Smooth body surface" - all internal mechanisms hidden
           - Only engine nozzle bell visible externally -->
      <body name="tvc_frame" pos="0 0 -2.0">
        <!-- Engine bay structural mount - DEEP inside rocket body -->
        <geom name="engine_bay" type="cylinder" pos="0 0 0.4" size="0.22 0.25" material="rocket_black" mass="5.0" contype="0" conaffinity="0"/>

        <!-- TVC gimbal housing - compact, fully internal -->
        <geom name="tvc_housing" type="cylinder" pos="0 0 0.2" size="0.24 0.1" material="gimbal_frame" mass="6.0" contype="0" conaffinity="0"/>

        <!-- Hydraulic actuators - concealed inside housing -->
        <geom name="actuator_1" type="box" pos="0.20 0 0.2" size="0.03 0.025 0.05" material="engine_metal" mass="0.8" contype="0" conaffinity="0"/>
        <geom name="actuator_2" type="box" pos="-0.20 0 0.2" size="0.03 0.025 0.05" material="engine_metal" mass="0.8" contype="0" conaffinity="0"/>
        <geom name="actuator_3" type="box" pos="0 0.20 0.2" size="0.025 0.03 0.05" material="engine_metal" mass="0.8" contype="0" conaffinity="0"/>
        <geom name="actuator_4" type="box" pos="0 -0.20 0.2" size="0.025 0.03 0.05" material="engine_metal" mass="0.8" contype="0" conaffinity="0"/>

          <!-- Gimbal X-axis (pitch) - Pivot point at engine mount, fully internal 
               PIVOT POINT at engine mount interface (inside rocket) -->
        <body name="gimbal_x" pos="0 0 0.05">
          <joint name="tvc_x" type="hinge" axis="1 0 0" range="-0.14 0.14" limited="true" damping="0.5" stiffness="0" armature="0.05"/>
          <!-- Gimbal ring - NON-COLLIDING (would interfere with rocket body walls) -->
          <geom name="gimbal_ring_x" type="cylinder" pos="0 0 0" size="0.22 0.02" material="gimbal_frame" mass="2.0" contype="0" conaffinity="0"/>
          
          <!-- X-axis bearings (compact, inside housing) - NON-COLLIDING -->
          <geom name="bearing_x1" type="cylinder" pos="0.22 0 0" size="0.02 0.03" material="engine_metal" mass="0.05" contype="0" conaffinity="0"/>
          <geom name="bearing_x2" type="cylinder" pos="-0.22 0 0" size="0.02 0.03" material="engine_metal" mass="0.05" contype="0" conaffinity="0"/>
          
          <!-- Y-axis gimbal (yaw) - Real F9 limit ±8° (0.14 rad) -->
          <body name="gimbal_y" pos="0 0 0">
            <joint name="tvc_y" type="hinge" axis="0 1 0" range="-0.14 0.14" limited="true" damping="0.5" stiffness="0" armature="0.05"/>
            <!-- Gimbal ring - NON-COLLIDING -->
            <geom name="gimbal_ring_y" type="cylinder" pos="0 0 0" size="0.18 0.015" material="gimbal_frame" mass="1.5" contype="0" conaffinity="0"/>
            
            <!-- Y-axis bearings (compact) - NON-COLLIDING -->
            <geom name="bearing_y1" type="cylinder" pos="0 0.18 0" size="0.015 0.025" material="engine_metal" mass="0.04" contype="0" conaffinity="0"/>
            <geom name="bearing_y2" type="cylinder" pos="0 -0.18 0" size="0.015 0.025" material="engine_metal" mass="0.04" contype="0" conaffinity="0"/>
            
            <!-- Hydraulic actuator rods connecting to engine (shorter, inside housing) - NON-COLLIDING -->
            <geom name="rod_1" type="capsule" fromto="0.14 0 0 0.22 0 0" size="0.01" material="engine_metal" mass="0.02" contype="0" conaffinity="0"/>
            <geom name="rod_2" type="capsule" fromto="-0.14 0 0 -0.22 0 0" size="0.01" material="engine_metal" mass="0.02" contype="0" conaffinity="0"/>
            <geom name="rod_3" type="capsule" fromto="0 0.14 0 0 0.22 0" size="0.01" material="engine_metal" mass="0.02" contype="0" conaffinity="0"/>
            <geom name="rod_4" type="capsule" fromto="0 -0.14 0 0 -0.22 0" size="0.01" material="engine_metal" mass="0.02" contype="0" conaffinity="0"/>

            <!-- REDESIGNED: Merlin-inspired engine - PROFESSIONAL APPEARANCE
                 Gimbal pivot inside rocket, only nozzle bell visible externally
                 Positioning ensures ALL internal components hidden -->
            <body name="engine" pos="0 0 -0.4">
              <!-- Turbopump assembly - FULLY INSIDE rocket body (non-colliding) -->
              <geom name="turbopump" type="cylinder" pos="0 0 0" size="0.06 0.08" material="engine_metal" mass="2.0" contype="0" conaffinity="0"/>

              <!-- Combustion chamber - FULLY INSIDE rocket body (non-colliding) -->
              <geom name="chamber" type="cylinder" pos="0 0 -0.15" size="0.10 0.12" material="engine_metal" mass="7.0" contype="0" conaffinity="0"/>

              <!-- Nozzle throat - AT rocket body bottom edge (transition point) -->
              <geom name="throat" type="cylinder" pos="0 0 -0.25" size="0.06 0.03" material="engine_metal" mass="2.5" contype="0" conaffinity="0"/>

              <!-- ONLY VISIBLE COMPONENT: Nozzle bell extending below rocket
                   Classic bell nozzle expansion with smooth taper -->
              <geom name="nozzle_1" type="cylinder" pos="0 0 -0.35" size="0.09 0.06" material="engine_metal" mass="2.0"/>
              <geom name="nozzle_2" type="cylinder" pos="0 0 -0.45" size="0.13 0.06" material="engine_metal" mass="1.5"/>
              <geom name="nozzle_3" type="cylinder" pos="0 0 -0.55" size="0.17 0.05" material="engine_metal" mass="1.0"/>

              <!-- Nozzle exit - wide bell opening (classic Merlin appearance) -->
              <geom name="nozzle_exit" type="cylinder" pos="0 0 -0.62" size="0.19 0.02" material="engine_metal" mass="0.5"/>
              
              <!-- Multi-layer thrust plume for dynamic visualization (fade via rgba alpha) -->
              <!-- FIXED: Initial alpha values set to visible (will be dynamically updated based on thrust) -->
              <!-- Layer 1: Short plume (0-30% thrust) -->
              <geom name="plume_short" type="capsule" fromto="0 0 -0.75 0 0 -1.2" size="0.10" rgba="0.98 0.5 0.1 0.6" contype="0" conaffinity="0" mass="0.001"/>
              
              <!-- Layer 2: Medium plume (30-60% thrust) -->
              <geom name="plume_medium" type="capsule" fromto="0 0 -0.75 0 0 -2.0" size="0.12" rgba="0.98 0.5 0.1 0.5" contype="0" conaffinity="0" mass="0.001"/>
              
              <!-- Layer 3: Long plume (60-100% thrust) -->
              <geom name="plume_long" type="capsule" fromto="0 0 -0.75 0 0 -2.8" size="0.14" rgba="0.98 0.5 0.1 0.4" contype="0" conaffinity="0" mass="0.001"/>
              
              <!-- Outer dispersed plume -->
              <geom name="plume_outer" type="capsule" fromto="0 0 -0.75 0 0 -3.2" size="0.18" rgba="0.9 0.4 0.05 0.3" contype="0" conaffinity="0" mass="0.001"/>
              
              <!-- Thrust measurement point -->
              <site name="thrust_site" pos="0 0 -1.5" size="0.05" rgba="1 0.5 0 1"/>
            </body>
          </body>
        </body>
      </body>
    </body>

    <!-- Enhanced camera setup for 3D training visualization -->
    <!-- Default camera - custom user-defined position -->
    <camera name="default_view" mode="fixed" pos="-98.627 -4.881 60.118" xyaxes="0.049 -0.999 0.000 0.519 0.026 0.854" fovy="45"/>
    <camera name="follow" mode="trackcom" target="vehicle" pos="0 -12 6" fovy="50"/>
    <camera name="chase" mode="track" target="vehicle" pos="0 -8 4" fovy="45"/>
    <camera name="tvc_detail" mode="track" target="tvc_frame" pos="2 -3 -2" fovy="25"/>
    <camera name="side_view" mode="track" target="vehicle" pos="8 0 4" fovy="40"/>
    <camera name="top_down" mode="track" target="vehicle" pos="0 0 20" fovy="35"/>
    <camera name="ground_view" mode="track" target="vehicle" pos="0 -4 1" fovy="60"/>
    <camera name="cinematic" mode="track" target="vehicle" pos="-6 -10 8" fovy="55"/>
  </worldbody>

  <!-- 3D Control actuators: TVC + Thrust magnitude -->
  <actuator>
    <!-- TVC gimbal control - POSITION SERVOS with PD control -->
    <!-- Position servos with sufficient exploration noise CAN provide continuous control -->
    <!-- The key: policy must learn to VARY outputs based on feedback, not output constants -->
    <!-- kp = position gain (stiffness), kv = velocity gain (damping) -->
    <!-- High kp/kv = fast, tight tracking; critical for responsive control -->
    <!-- TUNING: Reduced kp 10000->5000 to fix vibration/jitter while maintaining hold -->
    <!-- kp = position gain (stiffness), kv = velocity gain (damping) -->
    <!-- High kp/kv = fast, tight tracking; critical for responsive control -->
    <!-- TUNING: Increased stiffness 5000 -> 8000 for faster rise time (was sluggish at 280ms) -->
    <position name="tvc_pitch" joint="tvc_x" kp="8000" kv="200" ctrlrange="-1 1"/>
    <position name="tvc_yaw" joint="tvc_y" kp="8000" kv="200" ctrlrange="-1 1"/>

  <!-- AI-controlled thrust magnitude: 8540 N max (matches dynamics.py) -->
  <!-- FIXED: Using motor actuator for direct force control at thrust site -->
  <!-- gear="0 0 8540 0 0 0" means: [force_x, force_y, force_z, torque_x, torque_y, torque_z] -->
  <!-- Only force_z (index 2) is non-zero, applying 8540N upward thrust -->
  <general name="thrust_control" site="thrust_site" ctrlrange="0 1" gear="0 0 8540 0 0 0" dyntype="none" gaintype="fixed" biastype="none"/>
  </actuator>

  <!-- Enhanced sensor suite for 3D state estimation -->
  <sensor>
    <!-- IMU cluster -->
    <accelerometer name="imu_acc" site="vehicle_cg"/>
    <gyro name="imu_gyro" site="vehicle_cg"/>
    <magnetometer name="imu_mag" site="vehicle_cg"/>
    
    <!-- TVC position feedback -->
    <jointpos name="tvc_x_pos" joint="tvc_x"/>
    <jointpos name="tvc_y_pos" joint="tvc_y"/>
    <jointvel name="tvc_x_vel" joint="tvc_x"/>
    <jointvel name="tvc_y_vel" joint="tvc_y"/>
    
    <!-- Full 6DOF state -->
    <framepos name="rocket_pos" objtype="body" objname="vehicle"/>
    <framequat name="rocket_orient" objtype="body" objname="vehicle"/>
    <framelinvel name="rocket_linvel" objtype="body" objname="vehicle"/>
    <frameangvel name="rocket_angvel" objtype="body" objname="vehicle"/>
    
    <!-- Thrust measurement -->
    <force name="thrust_force" site="thrust_site"/>
    
    <!-- Ground proximity -->
    <rangefinder name="altitude" site="vehicle_cg"/>
  </sensor>

  <!-- Visual enhancements -->
  <visual>
    <global offwidth="1920" offheight="1080" cameraid="0"/>
    <quality shadowsize="2048" offsamples="8"/>
    <map znear="0.1" zfar="100"/>
  </visual>

</mujoco>