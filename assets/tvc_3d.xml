<!--
  Realistic 3D MJCF model of a thrust-vector-controlled rocket with
  full 6DOF movement and AI-controlled thrust magnitude for real-time training.

  Scale: 1:100 SpaceX Falcon 9 First Stage
  - Real F9: 25,600 kg empty, 70m tall, 3.66m diameter
  - Model: ~256 kg, 0.7m tall, 0.0366m (3.66cm) diameter
  - Thrust: 8540 N max (T/W = 3.4, matching real F9)
  - TVC: ±8° gimbal (real Merlin 1D spec)
-->
<mujoco model="tvc_rocket_3d">
  <compiler angle="radian" inertiafromgeom="true"/>
  <option timestep="0.002" gravity="0 0 -9.81" integrator="RK4">
    <flag constraint="enable" limit="enable"/>
  </option>

  <default>
    <joint armature="0.0" damping="0.2" limited="true"/>
    <geom density="1000" friction="0.8 0.2 0.1"/>
    <motor gear="1" ctrlrange="-1 1"/>
  </default>

  <asset>
    <!-- Enhanced textures for 3D visualization -->
    <texture name="sky" type="skybox" builtin="gradient" rgb1="0.75 0.86 0.97" rgb2="0.94 0.98 1.0" width="1024" height="1024"/>
    
    <!-- Realistic grass ground texture - procedural checker pattern with natural grass colors -->
    <texture name="grass_texture" type="2d" builtin="checker" rgb1="0.2 0.45 0.15" rgb2="0.25 0.5 0.2" width="512" height="512"/>
    
    <!-- Enhanced materials for 3D realism -->
    <material name="ground_mat" texture="grass_texture" texrepeat="200 200" reflectance="0.02"/>
    <material name="rocket_white" rgba="0.95 0.95 0.98 1" specular="0.6" shininess="0.8"/>
    <material name="rocket_black" rgba="0.08 0.08 0.1 1" specular="0.4" shininess="0.6"/>
    <material name="engine_metal" rgba="0.4 0.42 0.48 1" specular="0.8" shininess="0.9"/>
    <material name="gimbal_frame" rgba="0.3 0.32 0.38 1" specular="0.7" shininess="0.8"/>
    <material name="flame" rgba="0.98 0.5 0.1 0.7" emission="0.6"/>
    <material name="thrust_trail" rgba="0.9 0.4 0.05 0.4" emission="0.4"/>
  </asset>

  <worldbody>
    <!-- Enhanced ground plane with landing area markers -->
    <body name="ground" pos="0 0 0">
      <geom name="ground_plane" type="plane" size="100 100 1" material="ground_mat"/>
      
      <!-- Landing pad visualization -->
      <geom name="landing_pad" type="cylinder" pos="0 0 0.01" size="2 0.01" rgba="1 1 0 0.8" contype="0" conaffinity="0"/>
      <geom name="landing_target" type="cylinder" pos="0 0 0.02" size="0.3 0.005" rgba="1 0 0 0.9" contype="0" conaffinity="0"/>
    </body>

    <!-- Realistic 3D rocket with full 6DOF movement - 256 kg total mass -->
    <!-- RESCALED: 2.0m height, 0.3m diameter (Large Drone Scale) -->
    <body name="vehicle" pos="0 0 8">
      <!-- Free joint for full 6DOF movement (position + orientation) -->
      <freejoint name="vehicle_free"/>

      <!-- Main Body: Height 2.0m (half-size 1.0), Radius 0.15m -->
      <geom name="rocket_main" type="cylinder" pos="0 0 0" size="0.15 1.0" material="rocket_white" mass="220.0"/>

      <!-- Nose Cone: Tangent ellipsoid blending at Z=1.0 -->
      <geom name="nose_cone" type="ellipsoid" 
            pos="0 0 1.0" 
            size="0.15 0.15 0.4" 
            material="rocket_white" 
            mass="10.0"
            contype="0" conaffinity="0"/>

      <!-- Grid Fins: Scaled down -->
      <geom name="fin_1" type="box" pos="0.20 0 -0.8" size="0.08 0.015 0.12" material="rocket_black" mass="2.5"/>
      <geom name="fin_2" type="box" pos="-0.20 0 -0.8" size="0.08 0.015 0.12" material="rocket_black" mass="2.5"/>
      <geom name="fin_3" type="box" pos="0 0.20 -0.8" size="0.015 0.08 0.12" material="rocket_black" mass="2.5"/>
      <geom name="fin_4" type="box" pos="0 -0.20 -0.8" size="0.015 0.08 0.12" material="rocket_black" mass="2.5"/>

      <!-- Landing Legs: Scaled down -->
      <geom name="leg_1" type="capsule" fromto="0.12 0.12 -0.8 0.25 0.25 -1.2" size="0.015" material="rocket_black" mass="2.0"/>
      <geom name="leg_2" type="capsule" fromto="-0.12 0.12 -0.8 -0.25 0.25 -1.2" size="0.015" material="rocket_black" mass="2.0"/>
      <geom name="leg_3" type="capsule" fromto="-0.12 -0.12 -0.8 -0.25 -0.25 -1.2" size="0.015" material="rocket_black" mass="2.0"/>
      <geom name="leg_4" type="capsule" fromto="0.12 -0.12 -0.8 0.25 -0.25 -1.2" size="0.015" material="rocket_black" mass="2.0"/>
      
      <!-- Center of mass marker -->
      <site name="vehicle_cg" pos="0 0 0" size="0.03" rgba="1 0 0 1"/>
      
      <!-- TVC System: Condensed and moved up -->
      <body name="tvc_frame" pos="0 0 -0.8">
        <!-- Engine bay -->
        <geom name="engine_bay" type="cylinder" pos="0 0 0.15" size="0.13 0.1" material="rocket_black" mass="5.0" contype="0" conaffinity="0"/>

        <!-- TVC housing -->
        <geom name="tvc_housing" type="cylinder" pos="0 0 0.08" size="0.14 0.04" material="gimbal_frame" mass="6.0" contype="0" conaffinity="0"/>

        <!-- Actuators -->
        <geom name="actuator_1" type="box" pos="0.12 0 0.08" size="0.02 0.015 0.03" material="engine_metal" mass="0.8" contype="0" conaffinity="0"/>
        <geom name="actuator_2" type="box" pos="-0.12 0 0.08" size="0.02 0.015 0.03" material="engine_metal" mass="0.8" contype="0" conaffinity="0"/>
        
        <!-- Gimbal X (Pitch) -->
        <body name="gimbal_x" pos="0 0 0.02">
          <joint name="tvc_x" type="hinge" axis="1 0 0" range="-0.14 0.14" limited="true" damping="0.5" stiffness="0" armature="0.02"/>
          <geom name="gimbal_ring_x" type="cylinder" pos="0 0 0" size="0.12 0.01" material="gimbal_frame" mass="2.0" contype="0" conaffinity="0"/>
          
          <!-- Gimbal Y (Yaw) -->
          <body name="gimbal_y" pos="0 0 0">
            <joint name="tvc_y" type="hinge" axis="0 1 0" range="-0.14 0.14" limited="true" damping="0.5" stiffness="0" armature="0.02"/>
            <geom name="gimbal_ring_y" type="cylinder" pos="0 0 0" size="0.10 0.01" material="gimbal_frame" mass="1.5" contype="0" conaffinity="0"/>
            
            <!-- Engine: Scaled down Merlin -->
            <body name="engine" pos="0 0 -0.15">
              <geom name="turbopump" type="cylinder" pos="0 0 0" size="0.04 0.04" material="engine_metal" mass="2.0" contype="0" conaffinity="0"/>
              <geom name="chamber" type="cylinder" pos="0 0 -0.06" size="0.06 0.05" material="engine_metal" mass="7.0" contype="0" conaffinity="0"/>
              <geom name="throat" type="cylinder" pos="0 0 -0.10" size="0.03 0.02" material="engine_metal" mass="2.5" contype="0" conaffinity="0"/>
              
              <!-- Nozzle Bell -->
              <geom name="nozzle_1" type="cylinder" pos="0 0 -0.14" size="0.05 0.03" material="engine_metal" mass="2.0"/>
              <geom name="nozzle_2" type="cylinder" pos="0 0 -0.18" size="0.07 0.03" material="engine_metal" mass="1.5"/>
              <geom name="nozzle_exit" type="cylinder" pos="0 0 -0.22" size="0.09 0.01" material="engine_metal" mass="0.5"/>
              
              <!-- Exhaust Plumes -->
              <geom name="plume_short" type="capsule" fromto="0 0 -0.25 0 0 -0.5" size="0.05" rgba="0.98 0.5 0.1 0.6" contype="0" conaffinity="0" mass="0.001"/>
              <geom name="plume_medium" type="capsule" fromto="0 0 -0.25 0 0 -0.9" size="0.07" rgba="0.98 0.5 0.1 0.5" contype="0" conaffinity="0" mass="0.001"/>
              <geom name="plume_long" type="capsule" fromto="0 0 -0.25 0 0 -1.4" size="0.08" rgba="0.98 0.5 0.1 0.4" contype="0" conaffinity="0" mass="0.001"/>
              <geom name="plume_outer" type="capsule" fromto="0 0 -0.25 0 0 -1.6" size="0.10" rgba="0.9 0.4 0.05 0.3" contype="0" conaffinity="0" mass="0.001"/>
              
              <!-- Thrust Site -->
              <site name="thrust_site" pos="0 0 -0.2" size="0.03" rgba="1 0.5 0 1"/>
            </body>
          </body>
        </body>
      </body>
    </body>

    <!-- Default Camera: Moved closer for 2m rocket -->
    <camera name="default_view" mode="fixed" pos="-6 -6 4" xyaxes="1 -1 0 0.5 0.5 1" fovy="50"/>
    <camera name="follow" mode="trackcom" target="vehicle" pos="0 -5 1.5" fovy="60"/>
    <camera name="chase" mode="track" target="vehicle" pos="0 -3 1" fovy="60"/>
    <camera name="tvc_detail" mode="track" target="tvc_frame" pos="0.8 -0.8 -0.5" fovy="40"/>
  </worldbody>

  <actuator>
    <position name="tvc_pitch" joint="tvc_x" kp="5000" kv="200" ctrlrange="-1 1"/>
    <position name="tvc_yaw" joint="tvc_y" kp="5000" kv="200" ctrlrange="-1 1"/>
    <general name="thrust_control" site="thrust_site" ctrlrange="0 1" gear="0 0 8540 0 0 0" dyntype="none" gaintype="fixed" biastype="none"/>
  </actuator>

  <!-- Enhanced sensor suite for 3D state estimation -->
  <sensor>
    <!-- IMU cluster -->
    <accelerometer name="imu_acc" site="vehicle_cg"/>
    <gyro name="imu_gyro" site="vehicle_cg"/>
    <magnetometer name="imu_mag" site="vehicle_cg"/>
    
    <!-- TVC position feedback -->
    <jointpos name="tvc_x_pos" joint="tvc_x"/>
    <jointpos name="tvc_y_pos" joint="tvc_y"/>
    <jointvel name="tvc_x_vel" joint="tvc_x"/>
    <jointvel name="tvc_y_vel" joint="tvc_y"/>
    
    <!-- Full 6DOF state -->
    <framepos name="rocket_pos" objtype="body" objname="vehicle"/>
    <framequat name="rocket_orient" objtype="body" objname="vehicle"/>
    <framelinvel name="rocket_linvel" objtype="body" objname="vehicle"/>
    <frameangvel name="rocket_angvel" objtype="body" objname="vehicle"/>
    
    <!-- Thrust measurement -->
    <force name="thrust_force" site="thrust_site"/>
    
    <!-- Ground proximity -->
    <rangefinder name="altitude" site="vehicle_cg"/>
  </sensor>

  <!-- Visual enhancements -->
  <visual>
    <global offwidth="1920" offheight="1080" cameraid="0"/>
    <quality shadowsize="2048" offsamples="8"/>
    <map znear="0.1" zfar="100"/>
  </visual>

</mujoco>